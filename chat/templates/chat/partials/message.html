{% load i18n %}
<article role="article" data-message-id="{{ m.id }}" class="flex gap-2 p-2 rounded-lg bg-gray-50 {% if m.pinned_at %}border-l-4 border-yellow-400 bg-yellow-50{% endif %} {% if m.hidden_at %}opacity-60{% endif %}" tabindex="0">
  <div class="flex-shrink-0">
    {% if m.remetente.profile.avatar %}
      <img src="{{ m.remetente.profile.avatar.url }}" alt="" class="w-8 h-8 rounded-full" />
    {% else %}
      <span class="inline-block w-8 h-8 rounded-full bg-gray-300 text-sm flex items-center justify-center">{{ m.remetente.username|first|upper }}</span>
    {% endif %}
  </div>
  <div class="flex-1">
    <header class="flex items-center gap-2 text-xs text-gray-500">
      <span class="font-semibold text-gray-700">{{ m.remetente.username }}</span>
      <time datetime="{{ m.created|date:'c' }}">{{ m.created|date:"d/m/Y H:i" }}</time>
      {% if m.pinned_at %}<span class="text-primary" aria-label="{% trans 'Mensagem fixada' %}">📌</span>{% endif %}
      {% if m.hidden_at %}<span class="text-red-500">{% trans "Oculta" %}</span>{% endif %}
    </header>
    <div class="mt-1">
      {% if m.tipo == 'text' %}
        <p>{{ m.conteudo|linebreaksbr }}</p>
      {% elif m.tipo == 'image' %}
        <img src="{{ m.arquivo.url }}" alt="" class="max-w-xs rounded" />
      {% elif m.tipo == 'video' %}
        <video src="{{ m.arquivo.url }}" controls class="max-w-xs"></video>
      {% elif m.tipo == 'file' %}
        <a href="{{ m.arquivo.url }}" class="text-primary underline">{{ m.arquivo.name }}</a>
      {% endif %}
    </div>
    <div class="mt-2 flex items-center gap-2">
      <div class="reaction-container relative">
        <div class="reaction-menu hidden absolute bg-white border rounded p-1 flex gap-1">
          <button type="button" class="react-option" data-emoji="👍">👍</button>
          <button type="button" class="react-option" data-emoji="😂">😂</button>
          <button type="button" class="react-option" data-emoji="❤️">❤️</button>
          <button type="button" class="react-option" data-emoji="😮">😮</button>
        </div>
      </div>
      {% if is_admin %}
        <button
          hx-post="/api/chat/channels/{{ m.channel_id }}/messages/{{ m.id }}/pin/"
          class="text-xs text-neutral-600"
          aria-label="{% trans 'Fixar mensagem' %}"
          type="button"
        >
          📌
        </button>
      {% endif %}
      <ul class="reactions flex gap-2 ml-2">
        {% for emoji, count in m.reaction_counts.items %}
          <li class="text-sm">{{ emoji }} <span class="count">{{ count }}</span></li>
        {% endfor %}
      </ul>
    </div>
  </div>
</article>
