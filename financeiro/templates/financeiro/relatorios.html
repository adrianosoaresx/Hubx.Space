{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ _('Relatórios Financeiros') }}{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto p-4 space-y-4">
  <h1 class="text-2xl font-semibold mb-2">{{ _('Relatórios') }}</h1>
  <form id="relatorio-form" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="rel-centro" class="block text-sm font-medium text-gray-700">{{ _('Centro de Custo') }}</label>
        <select id="rel-centro" name="centro" class="mt-1 block w-full border rounded p-2">
          <option value="">{{ _('Todos') }}</option>
          {% for c in centros %}
            <option value="{{ c.id }}">{{ c.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="rel-nucleo" class="block text-sm font-medium text-gray-700">{{ _('Núcleo') }}</label>
        <select id="rel-nucleo" name="nucleo" class="mt-1 block w-full border rounded p-2">
          <option value="">{{ _('Todos') }}</option>
          {% for n in nucleos %}
            <option value="{{ n.id }}">{{ n.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="rel-periodo-inicial" class="block text-sm font-medium text-gray-700">{{ _('Período inicial') }}</label>
        <input id="rel-periodo-inicial" type="month" name="periodo_inicial" class="mt-1 block w-full border rounded p-2" />
      </div>
      <div>
        <label for="rel-periodo-final" class="block text-sm font-medium text-gray-700">{{ _('Período final') }}</label>
        <input id="rel-periodo-final" type="month" name="periodo_final" class="mt-1 block w-full border rounded p-2" />
      </div>
    </div>
    <button type="button" id="gerar-relatorio" class="bg-primary text-white px-4 py-2 rounded"
            hx-get="/api/financeiro/relatorios/"
            hx-target="#relatorio"
            hx-include="#relatorio-form"
            hx-trigger="click"
            hx-on="htmx:afterRequest: renderRelatorio(event)">
      {{ _('Gerar Relatório') }}
    </button>
  </form>

  <div id="relatorio" class="mt-6" aria-live="polite"></div>
  <div class="mt-4 flex gap-4">
    <a href="#" id="export-csv" class="text-primary underline" hx-boost="false" aria-label="{{ _('Exportar relatório em CSV') }}">{{ _('Exportar CSV') }}</a>
    <a href="#" id="export-xlsx" class="text-primary underline" hx-boost="false" aria-label="{{ _('Exportar relatório em XLSX') }}">{{ _('Exportar XLSX') }}</a>
  </div>
  <script>
    function renderRelatorio(evt) {
      const container = document.getElementById('relatorio');
      container.innerHTML = '';
      try {
        const data = JSON.parse(evt.detail.xhr.response);
        const rows = data.serie.map(r => `<tr><td class=\"px-2 py-1\">${r.mes}</td><td class=\"px-2 py-1\">${r.receitas}</td><td class=\"px-2 py-1\">${r.despesas}</td><td class=\"px-2 py-1\">${r.saldo}</td></tr>`).join('');
        container.innerHTML = `<p class=\"mb-2 font-medium\">{{ _('Saldo atual') }}: ${data.saldo_atual}</p><table class=\"min-w-full divide-y divide-gray-200\"><thead><tr><th class=\"px-2 py-1 text-left text-xs font-medium text-gray-500\">{{ _('Mês') }}</th><th class=\"px-2 py-1 text-left text-xs font-medium text-gray-500\">{{ _('Receitas') }}</th><th class=\"px-2 py-1 text-left text-xs font-medium text-gray-500\">{{ _('Despesas') }}</th><th class=\"px-2 py-1 text-left text-xs font-medium text-gray-500\">{{ _('Saldo') }}</th></tr></thead><tbody>${rows}</tbody></table>`;
        const params = new URLSearchParams(new FormData(document.getElementById('relatorio-form')));
        document.getElementById('export-csv').href = '/api/financeiro/relatorios/?' + params.toString() + '&format=csv';
        document.getElementById('export-xlsx').href = '/api/financeiro/relatorios/?' + params.toString() + '&format=xlsx';
      } catch (e) {
        container.textContent = 'Erro ao gerar relatório';
      }
    }
  </script>
</main>

{% endblock %}

