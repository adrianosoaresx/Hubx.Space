{% extends "base.html" %}
{% load static %}

{% block title %}Nova Postagem - Hubx{% endblock %}

{% block content %}
<section class="max-w-2xl mx-auto px-4 py-10">

  <!-- Cabeçalho -->
  <div class="mb-6 flex items-center gap-4">
    <a href="{% url 'feed:listar' %}" class="inline-flex items-center text-sm px-4 py-2 rounded-xl border border-neutral-300 text-neutral-700 hover:bg-neutral-100">
      <svg class="mr-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15,18 9,12 15,6"/>
      </svg>
      Voltar
    </a>
    <div>
      <h1 class="text-2xl font-bold text-neutral-900">Nova Postagem</h1>
      <p class="text-sm text-neutral-600">Compartilhe algo com sua comunidade</p>
    </div>
  </div>

  <!-- Formulário -->
  <form method="post" enctype="multipart/form-data" class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
    {% csrf_token %}

    <!-- Conteúdo -->
    <div>
      <label for="{{ form.conteudo.id_for_label }}" class="block text-sm font-medium text-neutral-700">
        {{ form.conteudo.label }}
      </label>
      <textarea
        id="{{ form.conteudo.id_for_label }}"
        name="{{ form.conteudo.name }}"
        class="mt-1 block w-full rounded-xl border border-neutral-300 shadow-sm focus:ring-primary-500 focus:border-primary-500 text-sm"
        placeholder="O que você gostaria de compartilhar?"
        rows="6"
        required
      >{{ form.conteudo.value|default_if_none:"" }}</textarea>
      {% if form.conteudo.errors %}
        <p class="text-red-500 text-xs mt-1">{{ form.conteudo.errors }}</p>
      {% endif %}
      <p class="text-sm text-neutral-500 mt-1">Compartilhe ideias, atualizações ou conteúdos com sua rede.</p>
    </div>

    <div class="mb-4">
      <label for="destino" class="font-semibold mb-1 block">Visibilidade</label>
      <select name="destino" id="destino" class="w-full rounded border-gray-300">
        <option value="publico">Público</option>
        {% for n in nucleos_do_usuario %}
          <option value="{{ n.id }}">Núcleo: {{ n.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Mídia -->
    <div>
      <label for="{{ form.media.id_for_label }}" class="block text-sm font-medium text-neutral-700">
        {{ form.media.label }}
      </label>
      <input
        type="file"
        id="{{ form.media.id_for_label }}"
        name="{{ form.media.name }}"
        class="mt-2 block w-full text-sm text-neutral-600 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-neutral-100 file:text-neutral-700 hover:file:bg-neutral-200"
      >
      {% if form.media.errors %}
        <p class="text-red-500 text-xs mt-1">{{ form.media.errors }}</p>
      {% endif %}
    </div>

    <!-- Ações -->
    <div class="flex justify-end gap-4 mt-6">
      <button type="submit"
              class="inline-flex items-center gap-2 rounded bg-emerald-600 px-5 py-2 text-white hover:bg-emerald-700 focus-visible:ring">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
          <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 0 1 0 1.42l-7.5 7.5a1 1 0 0 1-1.42 0l-3.5-3.5a1 1 0 1 1 1.42-1.42l2.79 2.79 6.79-6.79a1 1 0 0 1 1.42 0Z" clip-rule="evenodd" />
        </svg>
        Salvar
      </button>
      <a href="{% url 'feed:listar' %}"
         class="inline-flex items-center gap-2 rounded border border-neutral-300 px-5 py-2 hover:bg-neutral-100">
        Cancelar
      </a>
    </div>
  </form>
</section>

<script>
document.getElementById('{{ form.media.id_for_label }}')?.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      const preview = document.createElement('div');
      preview.className = "mt-4";
      let inner = `<p class="text-sm text-neutral-500">${file.name}</p>`;
      if (file.type.startsWith('image/')) {
        inner = `<img src="${evt.target.result}" class="max-w-xs rounded-xl shadow-sm mb-2"/>` + inner;
      }
      preview.innerHTML = inner;
      e.target.insertAdjacentElement('afterend', preview);
    };
    reader.readAsDataURL(file);
  }
});
</script>
{% endblock %}
